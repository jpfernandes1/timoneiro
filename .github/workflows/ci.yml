#Decision: Monorepo Strategy for Timoneiro Project

#  Context
#  Since Timoneiro project consists of a Spring Boot backend and a Next.js frontend, developed by a single developer as a portfolio project,
# a monorepo (single repository for both frontend and backend) was chosed considering:

#  Decision Drivers
# Development Velocity: Single developer working on both frontend and backend features
# Deployment Coordination: Features often require simultaneous frontend and backend changes
# Simplified CI/CD: Unified pipeline for building, testing, and deploying both components
# Project Scale: Medium-sized portfolio project, not enterprise-level complexity
# Learning Context: Educational environment where seeing the full stack is beneficial

#  Monorepo Advantages

# - unified_versioning: "Frontend and backend versions stay synchronized"
# - simplified_collaboration: "Single PR reviews full-stack features"
# - shared_configuration: "Common CI/CD, linting, and quality gates"
# - cross_component_refactoring: "Easy to update APIs across both layers"
# - developer_convenience: "Single clone, single set of issues/PRs"

#  trade_offs:

# - build_times: "Longer CI/CD runs when both components change"
# - repository_size: "Larger git repository with both codebases"
# - tooling_complexity: "More complex CI/CD configuration with path filters"
# - access_control: "Cannot grant different permissions for frontend/backend"
# - scaling_concerns: "May need to split if project grows beyond portfolio scope"

#  rejected_considerations:
# - independent_deployment: "Not necessary for coordinated portfolio features"
# - team_separation: "Single developer context makes this irrelevant"
# - repository_isolation: "Would create overhead for full-stack development"
# - technology_independence: "Frontend and backend are tightly coupled in this project"

#  implementation:
# - ci_cd_approach: "Conditional jobs with path-based triggers"
# - directory_structure: "Clear separation within single repository"
# - dependency_management: "Independent but coordinated via CI/CD"
# - deployment_orchestration: "Single pipeline with parallel execution"

#  [Monorepo] â†’ [GitHub] â†’ [CI: Backend Tests]  â†’  [CD: Deploy] â†’ [Production]
#                        â†˜ [CI: Frontend Tests] â†—

name: ğŸš€ Timoneiro Full Stack CI/CD

# --- TRIGGERS ---
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# --- GLOBAL CONFIGURATION ---
env:
  BACKEND_DIR: './backend'
  FRONTEND_DIR: './frontend'

# --- PARALLEL JOBS  ---
jobs:
  # JOB 1: BACKEND - SPRING BOOT
  backend-ci:
    name: â˜• Backend - Build & Test
    runs-on: ubuntu-latest

    # SMART TRIGGER - ONLY EXECUTES WHEN RELEVANT
    if: |
      contains(github.event.head_commit.message, '[backend]') ||
      contains(github.event.head_commit.message, '[all]') ||
      github.event_name == 'pull_request' ||
      contains(github.event.head_commit.modified, 'backend/') ||
      contains(github.event.head_commit.modified, '.github/workflows/')

    # NECESSARY SERVICES
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: timoneiro_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # STEP 1: Checkout
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # STEP 2: Cache Maven dependencies
      - name: ğŸ’¾ Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-

      # STEP 3: Setup Java
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # STEP 4: Wait for database
      - name: â³ Wait for PostgreSQL
        run: |
          echo "Waiting for database to be ready..."
          for i in {1..10}; do
            if pg_isready -h localhost -p 5432; then
              echo "âœ… Database is ready!"
              break
            fi
            echo "â° Attempt $i/10 - waiting..."
            sleep 3
          done

      # STEP 5: Build backend
      - name: ğŸ”¨ Build backend
        run: |
          cd ${{ env.BACKEND_DIR }}
          mvn -B clean compile
          echo "âœ… Backend compiled successfully"

      # STEP 6: Run tests
      - name: ğŸ§ª Run backend tests
        run: |
          cd ${{ env.BACKEND_DIR }}
          mvn test
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/timoneiro_test
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: postgres

      # STEP 7: Test coverage report
      - name: ğŸ“Š Generate test coverage
        run: |
          cd ${{ env.BACKEND_DIR }}
          mvn jacoco:report
          echo "ğŸ“ˆ Coverage report generated at target/site/jacoco/"

      # STEP 8: Build JAR for deployment
      - name: ğŸ“¦ Package application
        run: |
          cd ${{ env.BACKEND_DIR }}
          mvn package -DskipTests
          echo "ğŸ¯ Application packaged successfully"

      # STEP 9: Upload JAR as artifact (para deploy posterior)
      - name: ğŸ“¤ Upload backend artifact
        uses: actions/upload-artifact@v3
        with:
          name: backend-jar
          path: backend/target/*.jar
          retention-days: 1

#  # JOB 2: FRONTEND - NEXT.JS
#  frontend-ci:
#    name: ğŸ¨ Frontend - Build & Test
#    runs-on: ubuntu-latest
#
#    # SMART TRIGGER  -  EXECUTES ONLY WHEN RELEVANT
#    if: |
#      contains(github.event.head_commit.message, '[frontend]') ||
#      contains(github.event.head_commit.message, '[all]') ||
#      github.event_name == 'pull_request' ||
#      contains(github.event.head_commit.modified, 'frontend/') ||
#      contains(github.event.head_commit.modified, '.github/workflows/')
#
#    steps:
#      - name: ğŸ“¥ Checkout code
#        uses: actions/checkout@v4
#
#      - name: ğŸ’¾ Cache Node modules
#        uses: actions/cache@v3
#        with:
#          path: ~/.npm
#          key: npm-${{ hashFiles('**/package-lock.json') }}
#          restore-keys: |
#            npm-
#
#      - name: ğŸ“¦ Setup Node.js
#        uses: actions/setup-node@v4
#        with:
#          node-version: '18'
#          cache: 'npm'
#
#      - name: ğŸ“¥ Install dependencies
#        run: |
#          cd ${{ env.FRONTEND_DIR }}
#          npm ci
#          echo "âœ… Dependencies installed"
#
#      - name: ğŸ”¨ Build frontend
#        run: |
#          cd ${{ env.FRONTEND_DIR }}
#          npm run build
#          echo "âœ… Frontend built successfully"
#
#      - name: ğŸ” Lint code
#        run: |
#          cd ${{ env.FRONTEND_DIR }}
#          npm run lint || echo "âš ï¸  Linting not configured"
#
#      - name: ğŸ§ª Run tests
#        run: |
#          cd ${{ env.FRONTEND_DIR }}
#          npm test -- --watchAll=false --passWithNoTests || echo "âš ï¸  Tests not configured"

  # JOB 3: DEPLOY
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [backend-ci]  # âš ï¸ wait for both - add ",frontend-ci" inside brackets before frontend configured
    if: github.ref == 'refs/heads/main'  # âš ï¸ only on main branch

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # BACKEND DEPLOY
      - name: ğŸ¯ Deploy Backend to Heroku
        uses: akhileshns/heroku-deploy@v3.12.12
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "timoneiro-backend"
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          usedocker: true
          appdir: "backend"
        env:
          HD_BACKEND_DEPLOY: "true"

#      # FRONTEND DEPLOY
#      - name: ğŸ¨ Deploy Frontend to Vercel
#        run: |
#          echo "ğŸš€ Frontend deployment would happen here"
#          echo "Typically using: npx vercel --prod --token \$VERCEL_TOKEN"
#        # Para habilitar depois:
#        # env:
#        #   VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
#
#      - name: ğŸ“¢ Notify deployment success
#        run: |
#          echo "ğŸ‰ Deployment completed successfully!"
#          echo "Backend: https://timoneiro-backend.herokuapp.com"
#          echo "Frontend: https://timoneiro.vercel.app (future)"

  # JOB 4: SECURITY SCAN
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run security scan (Backend)
        run: |
          cd ${{ env.BACKEND_DIR }}
          mvn org.owasp:dependency-check-maven:check -DskipTests || echo "âš ï¸  Security vulnerabilities found"

      - name: ğŸ“‹ Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            backend/target/dependency-check-report.html
          retention-days: 7